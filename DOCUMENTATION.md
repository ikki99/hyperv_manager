# Hyper-V 统一管理器 - 功能规格文档

## 1. 虚拟机管理 (主视图)

- **虚拟机列表**:
  - 实时列出本机上所有的 Hyper-V 虚拟机。
  - 表格显示每台虚拟机的以下信息：
    - **名称**: 虚拟机的名称。
    - **状态**: 例如 “正在运行”, “已关闭”, “已保存” 等。
    - **网络状态**: 根据虚拟网卡的连接状态显示 “已连接”, “未连接”, “无网卡” 或 “状态异常”。
    - **操作系统**: 读取并显示虚拟机内部安装的客户机操作系统 (需要集成服务运行)。
    - **IP 地址**: 显示虚拟机获取到的所有 IP 地址。

- **虚拟机操作**:
  - **刷新**: 手动刷新虚拟机列表，获取最新状态。
  - **连接**: 对“正在运行”的虚拟机，调用 `vmconnect.exe` 打开虚拟机连接窗口。
  - **启动**: 启动处于“已关闭”、“已保存”或“已暂停”状态的虚拟机。
  - **设置网络**: 为选定的虚拟机配置网络适配器（打开一个新窗口）。
  - **执行命令**: 对“正在运行”的虚拟机，通过 PowerShell Direct 在其内部执行命令（需要提供虚拟机凭据）。
  - **关机**: 向虚拟机发送正常的关机信号 (Graceful Shutdown)。
  - **强制停止**: 强制关闭虚拟机电源 (Turn Off)。
  - **删除**: 从 Hyper-V 中移除虚拟机（会先尝试强制停止）。

## 2. 网络管理

- **虚拟交换机 (vSwitch) 列表**:
  - 列出本机上所有的虚拟交换机。
  - 表格显示每个交换机的以下信息：
    - **名称**: 交换机名称。
    - **类型**: “外部 (External)”, “内部 (Internal)”, 或 “专用 (Private)”。
    - **详情**: 对于内部交换机，显示其 NAT 状态和网关IP地址。
    - **备注**: 显示交换机的备注信息。

- **交换机操作**:
  - **创建交换机**: 打开向导，创建三种类型的虚拟交换机。创建外部交换机时，可绑定到物理网卡。
  - **删除交换机**: 删除选定的虚拟交换机。

- **NAT 网络配置 (针对内部交换机)**:
  - **创建 NAT 网络**: 为选定的内部交换机创建一个新的 NAT 网络，并指定子网掩码。
  - **设置网关 IP**: 为该交换机在主机上对应的虚拟网卡（`vEthernet`）配置IP地址和子网掩码，作为其下虚拟机的网关。
  - **端口转发**: 
    - 列出所有已存在的端口转发规则 (协议, 外部端口, 内部IP, 内部端口)。
    - 添加新的端口转发规则。
    - 删除指定的端口转发规则。

## 3. 创建虚拟机

- **多步骤向导**:
  - **步骤 1 (名称和位置)**: 设置虚拟机名称和文件存储路径，可选择是否启用安全启动。
  - **步骤 2 (内存和处理器)**: 通过滑块设置分配给虚拟机的内存大小和CPU核心数。
  - **步骤 3 (硬盘)**: 
    - **创建新硬盘**: 创建一个指定大小的动态虚拟硬盘 (.vhdx)。
    - **使用现有硬盘**: 选择一个已有的 .vhd 或 .vhdx 文件。
  - **步骤 4 (网络)**: 为虚拟机的主网卡选择一个已存在的虚拟交换机进行连接。
  - **步骤 5 (安装选项)**: 
    - **从本地文件**: 选择一个 .iso 镜像文件作为安装介质。
    - **从已下载镜像**: （此功能未完全实现）列出已下载的镜像供选择。
  - **步骤 6 (摘要)**: 显示所有配置信息，供用户最终确认。
  - **创建**: 根据以上所有配置，执行一系列 PowerShell 命令创建虚拟机。

## 4. 系统镜像管理

- **在线镜像市场**: 
  - 从本地的 `online_images_repository.json` 文件中读取一个预设的镜像列表。
  - 以卡片形式展示每个镜像的名称、版本、大小和描述。
  - 提供“在浏览器中打开”按钮，跳转到镜像的下载页面。

- **本地镜像**: 
  - 提供文件夹选择功能，扫描指定路径下的 .iso, .vhd, .vhdx 文件。
  - 在表格中列出扫描到的本地镜像的文件名、路径和大小。
  - 可选择一个本地镜像，并跳转到“创建虚拟机”向导，并预先填好该镜像的路径。

## 5. 系统检查

- **Hyper-V 状态检查**: 
  - 检查当前 Windows 系统中的 Hyper-V 功能是否已安装并启用。
  - 以不同颜色和文本提示检查结果（“已启用”, “未安装或未启用”, “权限不足”）。
- **一键安装**: 
  - 如果 Hyper-V 未安装，则显示此按钮。
  - 调用 PowerShell 命令来启用 Windows 的 Hyper-V 功能（需要管理员权限）。
